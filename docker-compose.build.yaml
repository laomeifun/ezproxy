version: "3.8"

services:
  ezproxy:
    # 核心修改：使用 build 指令构建当前目录下的 Dockerfile
    build:
      context: .
      dockerfile: Dockerfile
    # 给构建出的镜像起个名字
    image: ezproxy-custom:latest
    
    container_name: ezproxy
    restart: unless-stopped
    
    # Host 模式 (为了端口跳跃性能)
    network_mode: host
    
    # 权限 (为了 iptables 端口转发)
    cap_add:
      - NET_ADMIN

    # 数据持久化 (注意：这里不再挂载 entrypoint.sh 了)
    volumes:
      - ./data/conf:/etc/sing-box/conf
      - ./data/tls:/etc/sing-box/tls

    environment:
      # 强制自签证书
      - LE_MODE=selfsigned
      
      # 协议开关
      - ENABLE_REALITY=1
      - ENABLE_HYSTERIA2=1
      
      # 端口配置
      - REALITY_PORTS=443
      - HYSTERIA2_PORTS=50000
      
      # 复用配置
      - REUSE_CONFIG=1
