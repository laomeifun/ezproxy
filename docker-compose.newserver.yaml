version: "3.8"

services:
  sing-box:
    # 新服务器建议直接用本仓库构建镜像（包含 REUSE_CONFIG/LE_MODE 等逻辑修复）
    build:
      context: .
      dockerfile: Dockerfile
    image: ezproxy-fixed:local

    container_name: sing-box-auto
    restart: unless-stopped

    # 推荐 host 网络模式（性能好、少折腾端口映射）
    network_mode: host

    cap_add:
      - NET_ADMIN
      - NET_BIND_SERVICE

    volumes:
      # 持久化：配置/分享链接/部署信息（升级镜像不改变配置的关键）
      - ./data/config:/etc/sing-box/conf
      # 持久化：证书（自签或 LE 拷贝后的 crt/key）
      - ./data/tls:/etc/sing-box/tls
      # 持久化：Let's Encrypt 数据（如果你启用 LE）
      - ./data/letsencrypt:/etc/letsencrypt

    environment:
      # 关键：有 ./data/config/config.json 就复用；升级/重启不改 UUID/端口/Reality 密钥
      - REUSE_CONFIG=1

      # 证书模式：
      # - auto: 尝试 Let's Encrypt（需要宿主机 80/tcp 可用且公网可达），失败则回退自签
      # - selfsigned: 跳过 Let's Encrypt，直接自签（不需要 80 端口）
      # - letsencrypt: 强制 Let's Encrypt（失败则直接失败，不回退自签）
      - LE_MODE=auto

      # TLS 域名：
      # - 留空：自动用 <公网IP>.sslip.io
      # - 自定义域名：请先把域名解析到服务器公网 IP
      - CUSTOM_DOMAIN=

      # 节点名称前缀（可选）
      - NAME_PREFIX=sv1

      # 协议开关（1=启用, 0=禁用）
      - ENABLE_REALITY=1
      - ENABLE_ANYTLS=1
      - ENABLE_HYSTERIA2=1
      - ENABLE_TUIC=1

      # 端口：
      # - 留空：首次随机（但会写入 ./data/config/config.json 并被后续复用）
      # - 指定：固定端口（推荐你按需固定）
      - REALITY_PORTS=
      - ANYTLS_PORTS=
      - HYSTERIA2_PORTS=
      - TUIC_PORTS=

      # UUID：
      # - 留空：首次自动生成（并写入 ./data/config/config.json）
      # - 指定：固定 UUID
      - UUID=

      # Reality 设置（可选）
      - REALITY_SERVER_NAME=
      - REALITY_SERVER_PORT=443

      # Hysteria2 带宽（Mbps）
      - HYSTERIA2_UP_MBPS=100
      - HYSTERIA2_DOWN_MBPS=100

      # TUIC 拥塞控制
      - TUIC_CONGESTION=bbr

      - TZ=Asia/Shanghai
