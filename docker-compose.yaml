version: "3.8"

services:
  sing-box:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sing-box-auto
    restart: unless-stopped

    # Network mode: host is recommended for better performance
    # If using bridge mode, you need to expose ports explicitly
    network_mode: host

    # Alternatively, use bridge mode with specific ports:
    # ports:
    #   - "443:443/tcp"
    #   - "443:443/udp"
    #   - "8443:8443/tcp"
    #   - "8443:8443/udp"
    #   - "10000-10010:10000-10010/tcp"
    #   - "10000-10010:10000-10010/udp"

    volumes:
      # Persist certificates and configuration
      - ./data/tls:/etc/sing-box/tls
      - ./data/config:/etc/sing-box/conf
      # Optional: persist Let's Encrypt data
      - ./data/letsencrypt:/etc/letsencrypt

    environment:
      # Protocol enable flags (1=enable, 0=disable)
      # All protocols enabled by default
      - ENABLE_REALITY=1
      - ENABLE_ANYTLS=1
      - ENABLE_HYSTERIA2=1
      - ENABLE_TUIC=1

      # Ports configuration (comma-separated for multiple ports)
      # Leave empty for random port assignment
      - REALITY_PORTS=
      - ANYTLS_PORTS=
      - HYSTERIA2_PORTS=
      - TUIC_PORTS=

      # UUID (leave empty for auto-generation)
      - UUID=

      # Reality settings
      # Server name will be randomly selected from a list if not specified
      - REALITY_SERVER_NAME=
      - REALITY_SERVER_PORT=443

      # Hysteria2 bandwidth settings (Mbps)
      - HYSTERIA2_UP_MBPS=100
      - HYSTERIA2_DOWN_MBPS=100

      # TUIC congestion control: bbr, cubic, new_reno
      - TUIC_CONGESTION=bbr

      # Custom domain for TLS (optional)
      # If not set, uses sslip.io auto-generated domain (IP-based)
      # Example: example.com, proxy.mydomain.com
      - CUSTOM_DOMAIN=

      # Timezone
      - TZ=UTC

    # Required capabilities for network operations
    cap_add:
      - NET_ADMIN
      - NET_BIND_SERVICE

    # Security options
    security_opt:
      - no-new-privileges:true

    # Health check
    healthcheck:
      test: ["CMD", "sing-box", "check", "-c", "/etc/sing-box/config.json"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Example configurations:
#
# 1. Minimal setup (all auto):
#    Just run: docker-compose up -d
#
# 2. Custom UUID with specific ports:
#    environment:
#      - UUID=your-custom-uuid-here
#      - REALITY_PORTS=443
#      - ANYTLS_PORTS=8443
#      - HYSTERIA2_PORTS=10000
#      - TUIC_PORTS=10001
#
# 3. Multiple ports per protocol:
#    environment:
#      - REALITY_PORTS=443,444,445
#      - HYSTERIA2_PORTS=10000,10001,10002
#
# 4. Only enable specific protocols:
#    environment:
#      - ENABLE_REALITY=1
#      - ENABLE_ANYTLS=0
#      - ENABLE_HYSTERIA2=1
#      - ENABLE_TUIC=0
#
# 5. Custom Reality server name:
#    environment:
#      - REALITY_SERVER_NAME=www.microsoft.com
#      - REALITY_SERVER_PORT=443
#
# 6. Custom domain for TLS (instead of sslip.io):
#    environment:
#      - CUSTOM_DOMAIN=proxy.example.com
#    Note: You need to point your domain to the server IP
#    and ensure Let's Encrypt can issue a certificate for it.
